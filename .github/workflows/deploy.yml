name: Build and Deploy to Production

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: andreyvarela/korei

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=main-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        no-cache: true
        target: production
        
    - name: Verify image was pushed successfully
      run: |
        echo "ðŸ” Verifying image exists in registry..."
        echo "Expected tags: ${{ steps.meta.outputs.tags }}"
        echo "Attempting to pull main-SHA tag..."
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}
        echo "âœ… Image pull successful - build and push worked correctly"
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: 138.197.41.6
        username: deploy
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/korei
          
          # Backup current version
          if [ -d "korei-app" ]; then
            mv korei-app korei-app-backup-$(date +%Y%m%d-%H%M%S)
          fi
          
          # Clone new version for docker-compose files
          curl -L https://github.com/${{ github.repository }}/archive/main.tar.gz | tar xz
          mv korei-main korei-app
          cd korei-app
          
          # Create .env from secrets (with debug info)
          echo "ðŸ” DEBUG: Creating .env file with secrets..."
          cat > .env << EOF
          APP_NAME=Korei Assistant
          APP_VERSION=2.0.0
          ENVIRONMENT=production
          DEBUG=false
          PORT=8000
          
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY || secrets.SUPABASE_KEY || 'missing-supabase-service-key' }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY || secrets.SUPABASE_KEY || 'missing-supabase-anon-key' }}
          
          WHATSAPP_ACCESS_TOKEN=${{ secrets.WHATSAPP_CLOUD_TOKEN }}
          WHATSAPP_PHONE_NUMBER_ID=${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}
          WHATSAPP_BUSINESS_ACCOUNT_ID=${{ secrets.WHATSAPP_BUSINESS_ACCOUNT_ID }}
          WHATSAPP_VERIFY_TOKEN=${{ secrets.VERIFY_TOKEN }}
          
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_ORIGINS=https://api.whatsapp.com,https://korei.duckdns.org
          TIMEZONE=America/Costa_Rica
          LOG_LEVEL=INFO
          
          # Docker image info
          KOREI_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}
          EOF
          
          # Debug: Verify .env file was created correctly (without exposing secrets)
          echo "ðŸ” DEBUG: .env file variables (sanitized):"
          grep -E "^[A-Z_]+=.*" .env | sed 's/=.*/=***/' || echo "No variables found in .env"
          
          # Verify critical variables exist (without showing values)
          echo "ðŸ” DEBUG: Checking critical variables..."
          grep -q "WHATSAPP_ACCESS_TOKEN=" .env && echo "âœ… WHATSAPP_ACCESS_TOKEN found" || echo "âŒ WHATSAPP_ACCESS_TOKEN missing"
          grep -q "SUPABASE_SERVICE_KEY=" .env && echo "âœ… SUPABASE_SERVICE_KEY found" || echo "âŒ SUPABASE_SERVICE_KEY missing"
          grep -q "GEMINI_API_KEY=" .env && echo "âœ… GEMINI_API_KEY found" || echo "âŒ GEMINI_API_KEY missing"
          
          # Login to registry and pull latest image
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          
          # Stop current containers
          docker compose down || true
          
          # Pull the exact image built in this workflow
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}
          
          # Update docker-compose to use the specific image
          export KOREI_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}"
          
          # Verify image exists before deploying
          docker images | grep andreyvarela/korei || echo "Warning: Expected image not found"
          
          # Deploy with the new image
          docker compose up -d --force-recreate
          
          # Verify correct image is running
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" | grep korei
          
          # Cleanup old images (keep last 3)
          docker image prune -f
          
          # Verify deployment
          sleep 15
          echo "ðŸ” Checking containers status..."
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
          
          # Check both direct app and nginx proxy
          echo "ðŸ” Testing app direct access..."
          curl -f http://localhost:8000/health && echo "âœ… App direct access works" || echo "âŒ App direct access failed"
          
          echo "ðŸ” Testing nginx proxy access..."  
          if curl -f http://localhost/health; then
            echo "âœ… Deploy completed successfully!"
            echo "ðŸš€ Application is running at http://138.197.41.6"
          else
            echo "âŒ Health check failed!"
            docker logs korei-assistant --tail=50
            exit 1
          fi